---
import recipes from '../data/recipes.json';
import RecipeCard from '../components/RecipeCard.astro';
import BrewMateAuth from '../components/BrewMateAuth.jsx';
import SavedRecipes from '../components/SavedRecipes.jsx';
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BrewMate</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/global.css" />
  </head>
  <body class="bg-neutral-950 text-white min-h-screen">
    <!-- Sticky Header -->
    <header class="sticky top-0 z-50 bg-neutral-950 py-6 shadow-lg">
      <h1 class="text-center text-4xl font-bold">BrewMate Recipes</h1>
      <p class="text-center text-blue-400 underline mt-2">
        <a href="#recipes">Explore Recipes</a>
      </p>
    </header>

    <!-- Firebase Auth Controls -->
    <div class="text-center mt-6">
      <BrewMateAuth client:only="react" />
    </div>

    <!-- GPT Prompt UI -->
    <h2 class="text-center text-white text-xl font-semibold mt-12 mb-4">Ask BrewMate AI</h2>
    <div class="flex flex-col sm:flex-row gap-4 items-center justify-center px-4">
      <input
        id="gptPrompt"
        type="text"
        placeholder="e.g. What should I brew if I want something fruity with low ABV?"
        class="w-full sm:w-[400px] px-4 py-2 rounded-md text-black"
      />
      <button
        id="askBrewMateBtn"
        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded"
      >
        Ask BrewMate AI
      </button>
    </div>

    <!-- GPT Response Output -->
    <div id="gptResponse" class="text-white text-center mt-6 max-w-2xl mx-auto"></div>

    <!-- Save Recipe Button -->
    <div id="saveRecipeContainer" class="text-center mt-4 hidden">
      <button
        id="saveRecipeBtn"
        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded"
      >
        ðŸ“‚ Save This Recipe
      </button>
    </div>

    <!-- Main Content -->
    <main id="recipes" class="max-w-7xl mx-auto px-6 py-12">
      <div class="grid gap-8 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
        {recipes.map((recipe) => (
          <RecipeCard {...recipe} />
        ))}
      </div>
    </main>

    <!-- Saved Recipes (Rendered client-side if user is signed in) -->
    <SavedRecipes client:only="react" />

    <!-- Clean Footer -->
    <footer class="text-center text-xs text-gray-500 py-6">
      BrewMate Â© 2025
    </footer>

    <!-- GPT Prompt Script -->
    <script type="module">
      import { auth, saveUserRecipe } from "/src/firebase.js";

      async function askBrewMate() {
        const input = document.getElementById('gptPrompt');
        const output = document.getElementById('gptResponse');
        const prompt = input.value.trim();

        if (!prompt) {
          output.innerText = "Please enter a question.";
          return;
        }

        output.innerText = "Thinking... ðŸº";

        try {
          const res = await fetch('/api/ask-gpt', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt })
          });

          const data = await res.json();

          if (res.ok && data.answer) {
            output.innerText = data.answer;

            window.latestRecipe = {
              name: "AI-Generated Brew",
              style: "Experimental",
              abv: "unknown",
              instructions: data.answer,
              createdFromPrompt: prompt,
            };

            document.getElementById("saveRecipeContainer").classList.remove("hidden");
          } else {
            output.innerText = data.error || "Something went wrong.";
          }
        } catch (err) {
          console.error("GPT error:", err);
          output.innerText = "Failed to reach BrewMate AI.";
        }
      }

      async function handleSaveRecipe(recipe) {
        const user = auth.currentUser;
        if (!user) {
          alert("Please sign in to save recipes.");
          return;
        }

        if (!recipe || !recipe.name) {
          alert("No recipe to save.");
          return;
        }

        try {
          await saveUserRecipe(user, recipe);
          alert("âœ… Recipe saved to your BrewMate account!");
        } catch (err) {
          console.error("Save failed:", err);
          alert("âŒ Error saving recipe.");
        }
      }

      document.getElementById('askBrewMateBtn').addEventListener('click', askBrewMate);
      document.getElementById('saveRecipeBtn').addEventListener('click', () => handleSaveRecipe(window.latestRecipe));
    </script>
  </body>
</html>
